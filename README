# Pool Service
Controller for pool
NEW
NEW NEW

## Overview
This project is an Arduino-based application for the ESP32 that controls various modules including pumps, LEDs, temperatur sensor, and MQTT network communication. It uses PlatformIO as the build system.

## Features
- Chemicals are added using 3 12V peristaltic pumps.
- RGB LED strips for color gradients and ambience
- Temperature measurement in the pool
- Considered pH measurement in the pool in the pool
- MQTT communication for remote control
- Task-based architecture using TaskManager

## Hardware
![Motherboard](/pictures/Motherboard.png)

## Microcontroller
- ESP32 upesy_wroom

## Connectors
#### J1 - 5V supply
| PIN | Signal |<br>
|--1--|--+12V--|<br>
|--2--|--GND---|<br>
|--3--|--+5V---|<br>

#### J2 - aux 12V out
| PIN | Signal |<br>
|--1--|--+12V--|<br>
|--2--|--GND---|<br>
|--3--|--+5V---|<br>

#### J3 - Safety jumper
| PIN | Signal |<br>
|--1--|-----|<br>
|--2--|-----|<br>

#### J4 - 12V In main
| PIN | Signal |<br>
|--1--|---J3---|<br>
|--2--|+12V IN-|<br>

#### J5 - HCl pump
| PIN | Signal |<br>
|--1--|--C Q1--|<br>
|--2--|+12V IN-|<br>

#### J6 - NaOH pump
| PIN | Signal |<br>
|--1--|--C Q2--|<br>
|--2--|+12V IN-|<br>

#### J7 - Algizid pump
| PIN | Signal |<br>
|--1--|--C Q3--|<br>
|--2--|+12V IN-|<br>

#### J8 - not there

#### J9 - aux I°C not in use
| PIN | Signal |<br>
|--1--|--3V3---|<br>
|--2--|--GND---|<br>
|--3--|--SCL---|<br>
|--4--|--SDA---|<br>

#### J10 - Relays
| PIN | Signal | Color |<br>
|--1--|--NC----|-------|<br>
|--2--|--PONT--|-------|<br>
|--3--|--HEAT--|-------|<br>
|--4--|--GND---|-------|<br>
|--5--|--5V----|-------|<br>

#### J11 - Dallas temperature sensor
|--1--|--3V3---|<br>
|--2--|-Signal-|<br>
|--3--|--GND---|<br>

#### J12 - LED stripes
| PIN |  Signal   | Color |<br>
|--1--|----GND----|-------|<br>
|--2--|-LED red---|-------|<br>
|--3--|-LED blue--|-------|<br>
|--4--|-LED green-|-------|<br>
|--5--|-----5V-- -|-------|<br>


#### Valve Relays
|...Actor......|....Color.....|<br>
|....terrace---|--rown/blue---|<br>
|-----garden---|--grey/red----|<br>
|--pool füllen-|-green/black--|<br>
|-----+12V-----|-yellow/white-|<br>



## Software Architecture
The project follows a modular design with the following key components:

- **Task Management**: Using TaskManager for concurrent module operation
- **Network Communication**: MQTT protocol for remote control
- **Message Broker**: Centralized message handling system

### Network Configuration (secrets.h)
```cpp
#define SID "Your_WiFi_SSID"
#define PASSWORD "Your_WiFi_Password"
#define BROKER "MQTT_Broker_IP"
#define USER "MQTT_Username"
#define PW "MQTT_Password"
```

## MQTT Topics
The system uses the following MQTT topics for communication:

- `inGarden/#` - Incoming commands
- `outGarden/#` - Outgoing status updates

### Supported Commands

- inGarden/algizid_hclpump/state - Control algizid pump ON/OFF
- inGarden/hcl_pump/state - Control HCL pump ON/OFF
- `inGarden/naoh_pump/state` - Control NaOH pump ON/OFF
- `inGarden/garden_valve/state` - Control garden valve for watering
- `inGarden/rinse_valve/state` - Control rinse valve for pool
- `inGarden/terrace_valve/state` - Control terrace valve for watering
- Protection against uncontrolled pump action. -
- e.g. A pump PIN is HIGH (it means, the pump is off), but the pump is still running.
- `outGarden/algizid_error", "false"`
- `outGarden/naoh_error", "false"`
- `outGarden/hcl_error", "false"`

#### Monitor PINs
| PIN OUT | PIN Monotor | Error |<br>
|---LOW --|----LOW -----|--true-|<br>
|---HIGH--|----LOW------|-false-|<br>
|---LOW---|----HIGH-----|-false-|<br>
|---HIGH--|----High-----|--true-|<br>


- `inGarden/controller/config` - Controller configuration endpoint

### Debounce and Time out rules
- The debouncing is always checked after 200 milliseconds bot only the dosingpumps. The debounce time must be checked.
- The timeout depends on the specific pump. This option applies to all pumps.

### Controller Configuration
The controller now supports dynamic configuration through MQTT messages. The new configuration endpoint allows sending JSON payloads to `inGarden/controller/config` which will be processed and acknowledged with a response on `outGarden/controller/config`.

## Building and Flashing
1. Install PlatformIO
2. Configure your network settings in `src/secrets.h`
3. Build and upload using PlatformIO



